<div class="profile-page">
   <header class="profile-header">
      <img
         [src]="
            currentUser?.profilePicture || 'assets/images/default-avatar.png'
         "
         alt="Profile Picture"
         class="profile-avatar"
      />
      <div>
         <h1>{{ currentUser?.firstName }} {{ currentUser?.lastName }}</h1>
         <p *ngIf="currentUser?.username">
            {{ currentUser?.username }}
            <span *ngIf="currentUser?.training"
               >({{ currentUser?.training }})</span
            >
         </p>
         <p *ngIf="isEditingOtherUser" class="editing-notice">
            {{ "EDITING_USER_NOTICE" | translate }} {{ currentUser?.username }}
         </p>
      </div>
   </header>

   <div *ngIf="isLoading" class="loading-spinner">
      <p>{{ "LOADING_PROFILE" | translate }}...</p>
   </div>

   <form
      [formGroup]="profileForm"
      (ngSubmit)="onSubmit()"
      *ngIf="currentUser && !isLoading"
      class="profile-form"
   >
      <h2>
         {{
            (isEditingOtherUser
               ? "EDIT_USER_PROFILE_TITLE"
               : "PROFILE_EDIT_TITLE"
            ) | translate
         }}
      </h2>

      <fieldset class="form-section">
         <legend>{{ "PROFILE_BASIC_INFO_TITLE" | translate }}</legend>
         <div class="form-grid">
            <div class="form-field">
               <label for="profile-firstname">{{
                  "FIRST_NAME_LABEL" | translate
               }}</label>
               <input
                  id="profile-firstname"
                  type="text"
                  formControlName="firstName"
                  readonly
               />
            </div>
            <div class="form-field">
               <label for="profile-lastname">{{
                  "LAST_NAME_LABEL" | translate
               }}</label>
               <input
                  id="profile-lastname"
                  type="text"
                  formControlName="lastName"
                  readonly
               />
            </div>
            <div class="form-field">
               <label for="profile-username">{{
                  "USERNAME_LABEL" | translate
               }}</label>
               <input
                  id="profile-username"
                  type="text"
                  formControlName="username"
                  readonly
               />
            </div>
            <div class="form-field">
               <label for="profile-nickname">{{
                  "NICKNAME_LABEL" | translate
               }}</label>
               <input
                  id="profile-nickname"
                  type="text"
                  formControlName="nickname"
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
            </div>
            <div class="form-field">
               <label for="profile-picture">{{
                  "PROFILE_PICTURE_URL_LABEL" | translate
               }}</label>
               <input
                  id="profile-picture"
                  type="url"
                  formControlName="profilePicture"
                  placeholder="https://example.com/image.png"
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
            </div>
         </div>
      </fieldset>

      <fieldset class="form-section">
         <legend>{{ "PROFILE_PREFERENCES_TITLE" | translate }}</legend>
         <div class="form-grid">
            <div class="form-field">
               <label for="profile-theme">{{
                  "THEME_LABEL" | translate
               }}</label>
               <select
                  id="profile-theme"
                  formControlName="theme"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option *ngFor="let theme of themes" [value]="theme.value">
                     {{ theme.viewValueKey | translate }}
                  </option>
               </select>
            </div>
            <div class="form-field">
               <label for="profile-language">{{
                  "LANGUAGE_LABEL" | translate
               }}</label>
               <select
                  id="profile-language"
                  formControlName="language"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option *ngFor="let lang of languages" [value]="lang.value">
                     {{ lang.viewValueKey | translate }}
                  </option>
               </select>
            </div>
         </div>
      </fieldset>

      <app-email-form-section
         [parentForm]="profileForm"
         (emailAdded)="addEmailToForm()"
         (emailRemoved)="removeEmailFromForm($event)"
      >
      </app-email-form-section>

      <fieldset class="form-section" formArrayName="phoneNumbers">
         <legend>{{ "PROFILE_PHONES_TITLE" | translate }}</legend>
         <div
            *ngFor="let phoneGroup of phoneNumbersArray.controls; let i = index"
            [formGroupName]="i"
            class="form-array-item phone-item"
         >
            <div class="form-field">
               <label for="phone-number-{{ i }}"
                  >{{ "PHONE_NUMBER_LABEL" | translate }}*</label
               >
               <input
                  id="phone-number-{{ i }}"
                  type="tel"
                  formControlName="number"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     phoneGroup.get('number')?.invalid &&
                     (phoneGroup.get('number')?.touched ||
                        phoneGroup.get('number')?.dirty)
                  "
               >
                  {{
                     phoneGroup.get("number")?.errors ?? null
                        | getFormError : ("PHONE_NUMBER_LABEL" | translate)
                  }}
               </div>
            </div>
            <div class="form-field form-field-checkbox">
               <input
                  id="phone-default-{{ i }}"
                  type="checkbox"
                  formControlName="isDefault"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <label for="phone-default-{{ i }}" class="checkbox-label">{{
                  "SET_AS_DEFAULT_LABEL" | translate
               }}</label>
            </div>
            <button
               type="button"
               (click)="removePhoneNumber(i)"
               class="button-remove"
               [title]="'REMOVE_PHONE_TOOLTIP' | translate"
               [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
            >
               {{ "REMOVE_BUTTON" | translate }}
            </button>
         </div>
         <button
            type="button"
            (click)="addPhoneNumber()"
            class="button-add"
            [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
         >
            {{ "ADD_PHONE_BUTTON" | translate }}
         </button>
      </fieldset>

      <fieldset class="form-section" formArrayName="addresses">
         <legend>{{ "PROFILE_ADDRESSES_TITLE" | translate }}</legend>
         <div
            *ngFor="let addressGroup of addressesArray.controls; let i = index"
            [formGroupName]="i"
            class="form-array-item address-item"
         >
            <div class="form-field address-street">
               <label for="address-street-{{ i }}"
                  >{{ "STREET_ADDRESS_LABEL" | translate }}*</label
               >
               <input
                  id="address-street-{{ i }}"
                  type="text"
                  formControlName="streetAddress"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     addressGroup.get('streetAddress')?.invalid &&
                     (addressGroup.get('streetAddress')?.touched ||
                        addressGroup.get('streetAddress')?.dirty)
                  "
               >
                  {{
                     addressGroup.get("streetAddress")?.errors ?? null
                        | getFormError
                  }}
               </div>
            </div>
            <div class="form-field">
               <label for="address-city-{{ i }}"
                  >{{ "CITY_LABEL" | translate }}*</label
               >
               <input
                  id="address-city-{{ i }}"
                  type="text"
                  formControlName="city"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     addressGroup.get('city')?.invalid &&
                     (addressGroup.get('city')?.touched ||
                        addressGroup.get('city')?.dirty)
                  "
               >
                  {{ addressGroup.get("city")?.errors ?? null | getFormError }}
               </div>
            </div>
            <div class="form-field">
               <label for="address-postal-{{ i }}"
                  >{{ "POSTAL_CODE_LABEL" | translate }}*</label
               >
               <input
                  id="address-postal-{{ i }}"
                  type="text"
                  formControlName="postalCode"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     addressGroup.get('postalCode')?.invalid &&
                     (addressGroup.get('postalCode')?.touched ||
                        addressGroup.get('postalCode')?.dirty)
                  "
               >
                  {{
                     addressGroup.get("postalCode")?.errors ?? null
                        | getFormError
                  }}
               </div>
            </div>
            <div class="form-field">
               <label for="address-county-{{ i }}">{{
                  "COUNTY_LABEL" | translate
               }}</label>
               <input
                  id="address-county-{{ i }}"
                  type="text"
                  formControlName="county"
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
            </div>
            <div class="form-field">
               <label for="address-country-{{ i }}"
                  >{{ "COUNTRY_LABEL" | translate }}*</label
               >
               <input
                  id="address-country-{{ i }}"
                  type="text"
                  formControlName="country"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     addressGroup.get('country')?.invalid &&
                     (addressGroup.get('country')?.touched ||
                        addressGroup.get('country')?.dirty)
                  "
               >
                  {{
                     addressGroup.get("country")?.errors ?? null | getFormError
                  }}
               </div>
            </div>
            <div class="form-field">
               <label for="address-type-{{ i }}"
                  >{{ "TYPE_LABEL" | translate }}*</label
               >
               <select
                  id="address-type-{{ i }}"
                  formControlName="type"
                  required
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option
                     *ngFor="let type of addressTypes"
                     [value]="type.value"
                  >
                     {{ type.viewValueKey | translate }}
                  </option>
               </select>
            </div>
            <button
               type="button"
               (click)="removeAddress(i)"
               class="button-remove"
               [title]="'REMOVE_ADDRESS_TOOLTIP' | translate"
               [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
            >
               {{ "REMOVE_BUTTON" | translate }}
            </button>
         </div>
         <button
            type="button"
            (click)="addAddress()"
            class="button-add"
            [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
         >
            {{ "ADD_ADDRESS_BUTTON" | translate }}
         </button>
      </fieldset>

      <fieldset class="form-section" formArrayName="websites">
         <legend>{{ "PROFILE_WEBSITES_TITLE" | translate }}</legend>
         <div
            *ngFor="let websiteGroup of websitesArray.controls; let i = index"
            [formGroupName]="i"
            class="form-array-item website-item"
         >
            <div class="form-field">
               <label for="website-url-{{ i }}"
                  >{{ "URL_LABEL" | translate }}*</label
               >
               <input
                  id="website-url-{{ i }}"
                  type="url"
                  formControlName="url"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     websiteGroup.get('url')?.invalid &&
                     (websiteGroup.get('url')?.touched ||
                        websiteGroup.get('url')?.dirty)
                  "
               >
                  {{ websiteGroup.get("url")?.errors ?? null | getFormError }}
               </div>
            </div>
            <div class="form-field">
               <label for="website-type-{{ i }}">{{
                  "TYPE_LABEL" | translate
               }}</label>
               <select
                  id="website-type-{{ i }}"
                  formControlName="type"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option
                     *ngFor="let type of websiteTypes"
                     [value]="type.value"
                  >
                     {{ type.viewValueKey | translate }}
                  </option>
               </select>
            </div>
            <button
               type="button"
               (click)="removeWebsite(i)"
               class="button-remove"
               [title]="'REMOVE_WEBSITE_TOOLTIP' | translate"
               [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
            >
               {{ "REMOVE_BUTTON" | translate }}
            </button>
         </div>
         <button
            type="button"
            (click)="addWebsite()"
            class="button-add"
            [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
         >
            {{ "ADD_WEBSITE_BUTTON" | translate }}
         </button>
      </fieldset>

      <fieldset class="form-section" formArrayName="bankAccounts">
         <legend>{{ "PROFILE_BANK_ACCOUNTS_TITLE" | translate }}</legend>
         <div
            *ngFor="
               let accountGroup of bankAccountsArray.controls;
               let i = index
            "
            [formGroupName]="i"
            class="form-array-item bank-item"
         >
            <div class="form-field">
               <label for="bank-accountNumber-{{ i }}"
                  >{{ "ACCOUNT_NUMBER_LABEL" | translate }}*</label
               >
               <input
                  id="bank-accountNumber-{{ i }}"
                  type="text"
                  formControlName="accountNumber"
                  required
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <div
                  class="field-error"
                  *ngIf="
                     accountGroup.get('accountNumber')?.invalid &&
                     (accountGroup.get('accountNumber')?.touched ||
                        accountGroup.get('accountNumber')?.dirty)
                  "
               >
                  {{
                     accountGroup.get("accountNumber")?.errors ?? null
                        | getFormError
                  }}
               </div>
            </div>
            <div class="form-field">
               <label for="bank-owner-{{ i }}">{{
                  "OWNER_LABEL" | translate
               }}</label>
               <input
                  id="bank-owner-{{ i }}"
                  type="text"
                  formControlName="owner"
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
            </div>
            <div class="form-field">
               <label for="bank-type-{{ i }}"
                  >{{ "TYPE_LABEL" | translate }}*</label
               >
               <select
                  id="bank-type-{{ i }}"
                  formControlName="type"
                  required
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option
                     *ngFor="let type of bankAccountTypes"
                     [value]="type.value"
                  >
                     {{ type.viewValueKey | translate }}
                  </option>
               </select>
            </div>
            <div class="form-field">
               <label for="bank-bankName-{{ i }}">{{
                  "BANK_NAME_LABEL" | translate
               }}</label>
               <input
                  id="bank-bankName-{{ i }}"
                  type="text"
                  formControlName="bankName"
                  [readonly]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
            </div>
            <div class="form-field form-field-checkbox">
               <input
                  id="bank-isValid-{{ i }}"
                  type="checkbox"
                  formControlName="isValid"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <label for="bank-isValid-{{ i }}" class="checkbox-label">{{
                  "VALID_ACCOUNT_LABEL" | translate
               }}</label>
            </div>
            <div class="form-field form-field-checkbox">
               <input
                  id="bank-isDefault-{{ i }}"
                  type="checkbox"
                  formControlName="isDefault"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <label for="bank-isDefault-{{ i }}" class="checkbox-label">{{
                  "SET_AS_DEFAULT_LABEL" | translate
               }}</label>
            </div>
            <button
               type="button"
               (click)="removeBankAccount(i)"
               class="button-remove"
               [title]="'REMOVE_BANK_ACCOUNT_TOOLTIP' | translate"
               [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
            >
               {{ "REMOVE_BUTTON" | translate }}
            </button>
         </div>
         <button
            type="button"
            (click)="addBankAccount()"
            class="button-add"
            [disabled]="isEditingOtherUser && !canAdminEditCertainFields()"
         >
            {{ "ADD_BANK_ACCOUNT_BUTTON" | translate }}
         </button>
      </fieldset>

      <fieldset class="form-section" formGroupName="userSettings">
         <legend>{{ "PROFILE_USER_SETTINGS_TITLE" | translate }}</legend>
         <div class="form-grid">
            <div class="form-field form-field-checkbox">
               <input
                  id="profile-receiveNotifications"
                  type="checkbox"
                  formControlName="receiveNotifications"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               />
               <label
                  for="profile-receiveNotifications"
                  class="checkbox-label"
                  >{{ "RECEIVE_NOTIFICATIONS_LABEL" | translate }}</label
               >
            </div>
            <div class="form-field">
               <label for="profile-preferredContact">{{
                  "PREFERRED_CONTACT_METHOD_LABEL" | translate
               }}</label>
               <select
                  id="profile-preferredContact"
                  formControlName="preferredContactMethod"
                  [disabled]="
                     isEditingOtherUser && !canAdminEditCertainFields()
                  "
               >
                  <option value="email">{{ "EMAIL_LABEL" | translate }}</option>
                  <option value="phone">{{ "PHONE_LABEL" | translate }}</option>
                  <option value="none">{{ "NONE_LABEL" | translate }}</option>
               </select>
            </div>
         </div>
      </fieldset>

      <div
         class="form-actions"
         *ngIf="
            !isEditingOtherUser ||
            (isEditingOtherUser && canAdminEditCertainFields())
         "
      >
         <button
            type="submit"
            class="button-primary"
            [disabled]="isLoading || profileForm.invalid"
         >
            <span *ngIf="!isLoading">{{
               "SAVE_PROFILE_BUTTON" | translate
            }}</span>
            <span *ngIf="isLoading"
               >{{ "SAVING_PROFILE_BUTTON" | translate }}...</span
            >
         </button>
      </div>
   </form>

   <div *ngIf="!currentUser && !isLoading" class="profile-message">
      <p>
         {{ "PROFILE_NOT_LOADED" | translate }}
         <a routerLink="/login">{{ "LOGIN_HERE" | translate }}</a>
      </p>
   </div>
</div>
